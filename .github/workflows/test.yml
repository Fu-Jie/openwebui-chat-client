name: Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  detect-test-scope:
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.detect.outputs.should-run }}
      test-patterns: ${{ steps.detect.outputs.patterns }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies for detection
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML

    - name: Detect test scope
      id: detect
      run: |
        # Get changed files
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="${{ github.sha }}"
        else
          BASE_REF="HEAD~1"
          HEAD_REF="HEAD"
        fi
        
        echo "Comparing ${BASE_REF}...${HEAD_REF}"
        
        CHANGED_FILES=$(git diff --name-only ${BASE_REF}...${HEAD_REF} || git diff --name-only HEAD~1 HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Determine which test files to run
        python .github/scripts/detect_unit_tests.py "$BASE_REF" "$HEAD_REF"
        
        # Read outputs from script
        if [ -f /tmp/test-detection.json ]; then
          SHOULD_RUN=$(jq -r '.should_run' /tmp/test-detection.json)
          PATTERNS=$(jq -r '.patterns' /tmp/test-detection.json)
          
          echo "should-run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "patterns=$PATTERNS" >> $GITHUB_OUTPUT
          
          echo "Should run tests: $SHOULD_RUN"
          echo "Test patterns: $PATTERNS"
        else
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "patterns=test_*.py" >> $GITHUB_OUTPUT
          echo "Running all tests (detection failed)"
        fi

  test:
    runs-on: ubuntu-latest
    needs: detect-test-scope
    if: needs.detect-test-scope.outputs.should-run-tests == 'true'
    strategy:
      matrix:
        python-version:
          - '3.8'   # End of life: October 2024, consider deprecating
          - '3.9'   # End of life: October 2025
          - '3.10'  # End of life: October 2026 (LTS)
          - '3.11'  # End of life: October 2027
          - '3.12'  # End of life: October 2028 (LTS)
          - '3.13'  # Current stable
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[test]"

    - name: Set environment variables for unit tests (mock data)
      run: |
        echo "OPENWEBUI_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
        echo "OPENWEBUI_TOKEN=test-token-for-ci" >> $GITHUB_ENV
        echo "OPENWEBUI_DEFAULT_MODEL=test-model" >> $GITHUB_ENV

    - name: Run selected tests
      id: test-run
      run: |
        TEST_MODULES="${{ needs.detect-test-scope.outputs.test-patterns }}"
        
        # Ê£ÄÊü•ÊòØÂê¶ÊúâÊµãËØïË¶ÅËøêË°å
        if [ -z "$TEST_MODULES" ]; then
          echo "‚ùå No test modules specified"
          exit 1
        fi
        
        echo "Running tests for modules: $TEST_MODULES"
        export PYTHONPATH=.
        
        # ËøêË°åÊµãËØïÂπ∂‰øùÂ≠òËæìÂá∫Âà∞Êó•ÂøóÊñá‰ª∂
        python -m unittest ${TEST_MODULES} -v 2>&1 | tee test_output.log
        echo "exit_code=$?" >> $GITHUB_OUTPUT

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-logs-python-${{ matrix.python-version }}
        path: test_output.log
        retention-days: 7

  test-summary:
    runs-on: ubuntu-latest
    needs: [detect-test-scope, test]
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        if [ "${{ needs.detect-test-scope.outputs.should-run-tests }}" = "false" ]; then
          echo "‚è≠Ô∏è  No tests needed for these changes"
          echo ""
          echo "Changed files don't require unit tests to run."
        elif [ "${{ needs.test.result }}" = "success" ]; then
          echo "‚úÖ All selected tests passed!"
          echo ""
          echo "Test pattern used: ${{ needs.detect-test-scope.outputs.test-patterns }}"
        else
          echo "‚ùå Some tests failed"
          echo ""
          echo "Test pattern used: ${{ needs.detect-test-scope.outputs.test-patterns }}"
          echo ""
          echo "üìã Test logs have been saved as artifacts for debugging."
          echo "Check the Artifacts section above to download test logs."
          exit 1
        fi

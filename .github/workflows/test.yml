name: Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  detect-test-scope:
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.detect.outputs.should-run }}
      test-patterns: ${{ steps.detect.outputs.patterns }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies for detection
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML

    - name: Detect test scope
      id: detect
      run: |
        # Get changed files
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="${{ github.sha }}"
        else
          BASE_REF="HEAD~1"
          HEAD_REF="HEAD"
        fi
        
        echo "Comparing ${BASE_REF}...${HEAD_REF}"
        
        CHANGED_FILES=$(git diff --name-only ${BASE_REF}...${HEAD_REF} || git diff --name-only HEAD~1 HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Determine which test files to run
        python .github/scripts/detect_unit_tests.py "$BASE_REF" "$HEAD_REF"
        
        # Read outputs from script
        if [ -f /tmp/test-detection.json ]; then
          SHOULD_RUN=$(jq -r '.should_run' /tmp/test-detection.json)
          PATTERNS=$(jq -r '.patterns' /tmp/test-detection.json)
          
          echo "should-run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "patterns=$PATTERNS" >> $GITHUB_OUTPUT
          
          echo "Should run tests: $SHOULD_RUN"
          echo "Test patterns: $PATTERNS"
        else
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "patterns=test_*.py" >> $GITHUB_OUTPUT
          echo "Running all tests (detection failed)"
        fi

  test:
    runs-on: ubuntu-latest
    needs: detect-test-scope
    if: needs.detect-test-scope.outputs.should-run-tests == 'true'
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Set environment variables for integration tests
      run: |
        echo "OPENWEBUI_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
        echo "OPENWEBUI_TOKEN=test-token-for-ci" >> $GITHUB_ENV
        echo "OPENWEBUI_DEFAULT_MODEL=test-model" >> $GITHUB_ENV

    - name: Run selected tests
      run: |
        TEST_PATTERN="${{ needs.detect-test-scope.outputs.test-patterns }}"
        echo "Running tests matching pattern: $TEST_PATTERN"
        python -m unittest discover -s tests -p $TEST_PATTERN -v

  test-summary:
    runs-on: ubuntu-latest
    needs: [detect-test-scope, test]
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        if [ "${{ needs.detect-test-scope.outputs.should-run-tests }}" = "false" ]; then
          echo "⏭️  No tests needed for these changes"
          echo ""
          echo "Changed files don't require unit tests to run."
        elif [ "${{ needs.test.result }}" = "success" ]; then
          echo "✅ All selected tests passed!"
          echo ""
          echo "Test pattern used: ${{ needs.detect-test-scope.outputs.test-patterns }}"
        else
          echo "❌ Some tests failed"
          echo ""
          echo "Test pattern used: ${{ needs.detect-test-scope.outputs.test-patterns }}"
          exit 1
        fi
